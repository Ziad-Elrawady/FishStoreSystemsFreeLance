@model FishStoreSystem.ViewModels.CustomerDetailsViewModel
@using System.Globalization
@{
    ViewData["Title"] = "كشف حساب";
    var egyptCulture = new CultureInfo("ar-EG");
}

<h2 class="mb-4">
    <i class="bi bi-graph-up"></i> كشف حساب: @Model.Customer.Name
</h2>

@foreach (var inv in Model.OpenInvoices)
{
    <div class="card mb-3">
        <div class="card-header bg-warning fw-bold">
            فاتورة #@inv.Id — @inv.InvoiceDate.ToShortDateString()
        </div>

        <div class="card-body">
            <p>الإجمالي: <strong>@inv.TotalAmount.ToString("C", egyptCulture)</strong></p>
            <p>
                المتبقي:
                <span class="fw-bold text-danger">
                    @inv.RemainingAmount.ToString("C", egyptCulture)
                </span>
            </p>

            <h6>الأصناف</h6>
            <ul>
                @foreach (var item in inv.Items)
                {
                    <li>
                        @item.ItemName — @item.Quantity × @item.UnitPrice =
                        @item.TotalPrice.ToString("C", egyptCulture)
                    </li>
                }
            </ul>

            <hr />

            <form asp-controller="Invoices" asp-action="AddPayment" method="post" class="row g-2">
                <input type="hidden" name="invoiceId" value="@inv.Id" />

                <div class="col-md-4">
                    <input name="amount" type="number" step="0.01"
                           class="form-control" placeholder="مبلغ الدفع" required />
                </div>

                <div class="col-md-4">
                    <select name="method" class="form-select">
                        <option value="كاش">كاش</option>
                        <option value="فيزا">فيزا</option>
                        <option value="تحويل">تحويل بنكي</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <button type="submit" class="btn btn-success w-100">
                        ➕ إضافة دفعة
                    </button>
                </div>
            </form>

            @if (inv.Payments.Any())
            {
                <h6 class="mt-3">المدفوعات السابقة</h6>
                <ul>
                    @foreach (var p in inv.Payments)
                    {
                        <li>
                            @p.PaymentDate.ToShortDateString() —
                            @p.Amount.ToString("C", egyptCulture)
                            (@p.PaymentMethod)
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
}

<a href="/Customers" class="btn btn-primary mt-3">
    🔙 العودة
</a>
