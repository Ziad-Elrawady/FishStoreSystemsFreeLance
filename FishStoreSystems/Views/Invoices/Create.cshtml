@model FishStoreSystem.ViewModels.InvoiceCreateViewModel
@{
    ViewData["Title"] = "فاتورة جديدة";
}

<!-- ===== PAGE HEADER ===== -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold mb-0">🧾 فاتورة جديدة</h3>
    <a href="/Invoices" class="btn btn-secondary">🔙 رجوع</a>
</div>

<div class="card">
    <div class="card-body">

        <!-- ===== VALIDATION ERRORS ===== -->
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <li>@error.ErrorMessage</li>
                    }
                </ul>
            </div>
        }

        <form asp-action="Create" method="post" onsubmit="return beforeSubmit();">

            <!-- ===== CUSTOMER & DUE DATE ===== -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label asp-for="CustomerId" class="form-label fw-bold">الزبون</label>
                    <select asp-for="CustomerId"
                            asp-items="Model.CustomersList"
                            class="form-select"
                            required>
                    </select>
                </div>

                <div class="col-md-6">
                    <label asp-for="DueDate" class="form-label fw-bold">تاريخ الاستحقاق</label>
                    <input asp-for="DueDate"
                           class="form-control"
                           type="date"
                           value="@Model.DueDate.ToString("yyyy-MM-dd")"
                           required />
                </div>
            </div>

            <hr />

            <!-- ===== ITEMS ===== -->
            <h5 class="fw-bold mb-3">الأصناف</h5>

            <div id="itemsContainer">

                <!-- ITEM ROW -->
                <div class="item-row row g-2 mb-2 align-items-center">
                    <div class="col-md-5">
                        <input class="form-control item-name"
                               placeholder="اسم الصنف"
                               required />
                    </div>

                    <div class="col-md-2">
                        <input class="form-control quantity"
                               type="number"
                               step="0.25"
                               min="0"
                               placeholder="كمية"
                               required
                               oninput="updateTotal(this)" />
                    </div>

                    <div class="col-md-2">
                        <div class="input-group">
                            <input class="form-control unit-price"
                                   type="number"
                                   step="0.25"
                                   min="0"
                                   placeholder="السعر"
                                   required
                                   oninput="updateTotal(this)" />
                            <span class="input-group-text">EGP</span>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="input-group">
                            <input class="form-control total-price" readonly />

                            <span class="input-group-text">EGP</span>
                        </div>
                    </div>

                    <div class="col-md-1 text-center">
                        <button type="button"
                                class="btn btn-danger"
                                onclick="removeItem(this)">
                            ❌
                        </button>
                    </div>
                </div>

            </div>

            <button type="button"
                    class="btn btn-info mb-3"
                    onclick="addItem()">
                ➕ إضافة صنف
            </button>

            <hr />

            <!-- ===== TOTAL ===== -->
            <div class="mb-4">
                <label class="form-label fw-bold">إجمالي الفاتورة</label>
                <div class="input-group">
                    <input id="InvoiceTotal"
                           class="form-control fw-bold"
                           readonly />
                    <span class="input-group-text">EGP</span>
                </div>
            </div>

            <!-- ===== ACTIONS ===== -->
            <div class="text-center">
                <button type="submit" class="btn btn-success btn-lg px-5">
                    💾 حفظ الفاتورة
                </button>
                <a href="/Invoices" class="btn btn-secondary px-4">
                    إلغاء
                </a>
            </div>

        </form>
    </div>
</div>

<!-- ===== JAVASCRIPT ===== -->
<script>
    function addItem() {
        const container = document.getElementById('itemsContainer');
        const row = document.createElement('div');

        row.className = 'item-row row g-2 mb-2 align-items-center';

        row.innerHTML = `
            <div class="col-md-5">
                <input class="form-control item-name" placeholder="اسم الصنف" required />
            </div>

            <div class="col-md-2">
                <input class="form-control quantity" type="number" step="0.25" min="0"
                       placeholder="كمية" required oninput="updateTotal(this)" />
            </div>

            <div class="col-md-2">
                <div class="input-group">
                    <input class="form-control unit-price" type="number" step="0.25" min="0"
                           placeholder="السعر" required oninput="updateTotal(this)" />
                    <span class="input-group-text">EGP</span>
                </div>
            </div>

            <div class="col-md-2">
                <div class="input-group">
                    <input class="form-control total-price" readonly />
                    <span class="input-group-text">EGP</span>
                </div>
            </div>

            <div class="col-md-1 text-center">
                <button type="button" class="btn btn-danger" onclick="removeItem(this)">❌</button>
            </div>
        `;

        container.appendChild(row);
    }

    function removeItem(btn) {
        btn.closest('.item-row').remove();
        updateInvoiceTotal();
    }

    function updateTotal(input) {
        const row = input.closest('.item-row');
        const qty = parseFloat(row.querySelector('.quantity').value) || 0;
        const price = parseFloat(row.querySelector('.unit-price').value) || 0;
        row.querySelector('.total-price').value = (qty * price).toFixed(2);
        updateInvoiceTotal();
    }

    function updateInvoiceTotal() {
        let total = 0;
        document.querySelectorAll('.total-price').forEach(tp => {
            total += parseFloat(tp.value) || 0;
        });
        document.getElementById('InvoiceTotal').value = total.toFixed(2);
    }

    function reindexItems() {
        const rows = document.querySelectorAll('.item-row');
        rows.forEach((row, index) => {
            row.querySelector('.item-name').name  = `Items[${index}].ItemName`;
            row.querySelector('.quantity').name   = `Items[${index}].Quantity`;
            row.querySelector('.unit-price').name = `Items[${index}].UnitPrice`;
            // ❌ متبعتش TotalPrice نهائي
        });
    }


    function beforeSubmit() {
        reindexItems();

        const total = parseFloat(document.getElementById('InvoiceTotal').value) || 0;
        if (total <= 0) {
            alert('لا يمكن حفظ فاتورة بدون أصناف');
            return false;
        }
        return true;
    }

    updateInvoiceTotal();
</script>
